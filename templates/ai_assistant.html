{% extends "base.html" %}

{% block title %}AI助手 - 网络智能监控平台{% endblock %}

{% block header %}AI网络助手{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">网络诊断</h5>
            </div>
            <div class="card-body">
                <form id="diagnostic-form">
                    <div class="mb-3">
                        <label for="device-select" class="form-label">选择设备</label>
                        <select class="form-select" id="device-select" name="device_id" required>
                            <option value="" selected disabled>请选择设备</option>
                            {% if devices %}
                                {% for device in devices %}
                                    <option value="{{ device.id }}">{{ device.name }} ({{ device.ip_address }})</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="issue-description" class="form-label">问题描述</label>
                        <textarea class="form-control" id="issue-description" name="issue_description" rows="3" placeholder="请描述您遇到的网络问题..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" id="diagnostic-submit">
                        <span class="spinner-border spinner-border-sm d-none" id="diagnostic-spinner" role="status" aria-hidden="true"></span>
                        开始诊断
                    </button>
                </form>
                
                <div class="mt-4 d-none" id="diagnostic-result">
                    <h5>诊断结果</h5>
                    <div class="alert alert-info" id="diagnostic-content">
                        <!-- 诊断结果将在这里显示 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">智能对话</h5>
            </div>
            <div class="card-body">
                <div class="chat-container" id="chat-container">
                    <div class="chat-messages" id="chat-messages">
                        <div class="message assistant">
                            <div class="message-content">
                                <p>您好，我是网络智能助手。我可以帮助您解答网络相关问题、分析网络性能、提供故障排除建议，以及针对您的网络环境提出优化建议。请问有什么可以帮助您的？</p>
                            </div>
                        </div>
                    </div>
                    <div class="chat-input">
                        <form id="chat-form">
                            <div class="input-group">
                                <input type="text" class="form-control" id="chat-input" placeholder="输入您的问题..." autocomplete="off">
                                <button class="btn btn-primary" type="submit" id="chat-submit">
                                    <span class="spinner-border spinner-border-sm d-none" id="chat-spinner" role="status" aria-hidden="true"></span>
                                    发送
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const diagnosticForm = document.getElementById('diagnostic-form');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        
        // 诊断表单提交事件
        if (diagnosticForm) {
            diagnosticForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 显示加载动画
                document.getElementById('diagnostic-spinner').classList.remove('d-none');
                document.getElementById('diagnostic-submit').setAttribute('disabled', 'disabled');
                
                // 获取表单数据
                const deviceId = document.getElementById('device-select').value;
                const issueDescription = document.getElementById('issue-description').value;
                
                // 调用诊断API
                generateDiagnostic(deviceId, issueDescription);
            });
        }
        
        // 聊天提交事件
        if (chatForm) {
            chatForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const userInput = chatInput.value.trim();
                if (!userInput) return;
                
                // 添加用户消息
                addMessage('user', userInput);
                
                // 清空输入框
                chatInput.value = '';
                
                // 显示加载动画
                document.getElementById('chat-spinner').classList.remove('d-none');
                document.getElementById('chat-submit').setAttribute('disabled', 'disabled');
                
                // 发送到后端，获取AI助手回复
                fetch('/api/assistant', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: userInput }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 添加助手回复
                        addMessage('assistant', data.response);
                    } else {
                        // 显示错误消息
                        addMessage('assistant', '抱歉，我无法处理您的请求。' + (data.error || ''));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    addMessage('assistant', '抱歉，发生了错误。请稍后再试。');
                })
                .finally(() => {
                    // 隐藏加载动画
                    document.getElementById('chat-spinner').classList.add('d-none');
                    document.getElementById('chat-submit').removeAttribute('disabled');
                });
            });
        }
        
        // 添加消息到聊天窗口
        function addMessage(sender, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const paragraph = document.createElement('p');
            paragraph.textContent = content;
            
            contentDiv.appendChild(paragraph);
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            
            // 滚动到底部
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // 生成诊断结果
        function generateDiagnostic(deviceId, issueDescription) {
            fetch('/api/device/diagnose', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    device_id: deviceId,
                    issue_description: issueDescription
                }),
            })
            .then(response => response.json())
            .then(data => {
                // 显示诊断结果区域
                document.getElementById('diagnostic-result').classList.remove('d-none');
                
                const diagnosticContent = document.getElementById('diagnostic-content');
                
                if (data.success) {
                    let resultHtml = '';
                    
                    // 设备信息
                    if (data.device_info) {
                        resultHtml += `<h6>设备信息</h6>
                                      <p><strong>名称:</strong> ${data.device_info.name || '未知'}</p>
                                      <p><strong>IP地址:</strong> ${data.device_info.ip_address || '未知'}</p>
                                      <p><strong>状态:</strong> <span class="badge ${getBadgeClass(data.device_info.status)}">${getStatusText(data.device_info.status)}</span></p>`;
                    }
                    
                    // 诊断结果
                    resultHtml += `<h6>问题诊断</h6>
                                  <p>${data.diagnosis || '无法生成诊断结果'}</p>`;
                    
                    // 建议措施
                    if (data.suggestions && data.suggestions.length > 0) {
                        resultHtml += `<h6>建议措施</h6><ul>`;
                        data.suggestions.forEach(suggestion => {
                            resultHtml += `<li>${suggestion}</li>`;
                        });
                        resultHtml += `</ul>`;
                    }
                    
                    diagnosticContent.innerHTML = resultHtml;
                    diagnosticContent.className = 'alert alert-info';
                } else {
                    diagnosticContent.innerHTML = `<p>诊断失败: ${data.message || '未知错误'}</p>`;
                    diagnosticContent.className = 'alert alert-danger';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('diagnostic-result').classList.remove('d-none');
                const diagnosticContent = document.getElementById('diagnostic-content');
                diagnosticContent.innerHTML = '<p>诊断过程中发生错误，请稍后再试</p>';
                diagnosticContent.className = 'alert alert-danger';
            })
            .finally(() => {
                // 隐藏加载动画
                document.getElementById('diagnostic-spinner').classList.add('d-none');
                document.getElementById('diagnostic-submit').removeAttribute('disabled');
            });
        }
        
        // 获取设备状态对应的徽章样式
        function getBadgeClass(status) {
            switch(status) {
                case 'online': return 'bg-success';
                case 'offline': return 'bg-danger';
                case 'warning': return 'bg-warning';
                default: return 'bg-secondary';
            }
        }
        
        // 获取状态文本
        function getStatusText(status) {
            switch(status) {
                case 'online': return '在线';
                case 'offline': return '离线';
                case 'warning': return '警告';
                default: return '未知';
            }
        }
    });
</script>
<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: 400px;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        display: flex;
        flex-direction: column;
    }
    
    .chat-input {
        border-top: 1px solid #dee2e6;
        padding: 10px;
    }
    
    .message {
        margin-bottom: 10px;
        max-width: 80%;
    }
    
    .message.user {
        align-self: flex-end;
    }
    
    .message.assistant {
        align-self: flex-start;
    }
    
    .message-content {
        padding: 10px;
        border-radius: 0.75rem;
    }
    
    .message.user .message-content {
        background-color: #007bff;
        color: white;
        border-bottom-right-radius: 0;
    }
    
    .message.assistant .message-content {
        background-color: #f0f0f0;
        border-bottom-left-radius: 0;
    }
    
    .message p {
        margin-bottom: 0;
    }
</style>
{% endblock %}
