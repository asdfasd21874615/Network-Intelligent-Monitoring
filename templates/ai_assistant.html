{% extends "base.html" %}

{% block title %}AI助手 - 网络智能监控平台{% endblock %}

{% block header %}AI网络助手{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">智能网络分析与建议</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    AI助手通过分析网络设备的历史和实时数据，提供智能化的网络分析和优化建议。
                </p>
                
                <div id="ai-insights-container">
                    {% if insights %}
                        {% for insight in insights %}
                            <div class="alert alert-primary mb-3">
                                <h5>{{ insight.title }}</h5>
                                <p>{{ insight.description }}</p>
                                <small class="text-muted">生成时间: {{ insight.timestamp|timestamp_to_datetime }}</small>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-info">
                            <h5>暂无洞察</h5>
                            <p>AI助手尚未生成任何网络洞察。请确保您的网络设备正在被监控，并且有足够的历史数据用于分析。</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">网络诊断</h5>
            </div>
            <div class="card-body">
                <form id="diagnostic-form">
                    <div class="mb-3">
                        <label for="device-select" class="form-label">选择设备</label>
                        <select class="form-select" id="device-select" name="device_id" required>
                            <option value="" selected disabled>请选择设备</option>
                            {% if devices %}
                                {% for device in devices %}
                                    <option value="{{ device.id }}">{{ device.name }} ({{ device.ip_address }})</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="issue-description" class="form-label">问题描述</label>
                        <textarea class="form-control" id="issue-description" name="issue_description" rows="3" placeholder="请描述您遇到的网络问题..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" id="diagnostic-submit">
                        <span class="spinner-border spinner-border-sm d-none" id="diagnostic-spinner" role="status" aria-hidden="true"></span>
                        开始诊断
                    </button>
                </form>
                
                <div class="mt-4 d-none" id="diagnostic-result">
                    <h5>诊断结果</h5>
                    <div class="alert alert-info" id="diagnostic-content">
                        <!-- 诊断结果将在这里显示 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">智能对话</h5>
            </div>
            <div class="card-body">
                <div class="chat-container" id="chat-container">
                    <div class="chat-messages" id="chat-messages">
                        <div class="message assistant">
                            <div class="message-content">
                                <p>您好，我是网络智能助手。我可以帮助您解答网络相关问题、分析网络性能、提供故障排除建议，以及针对您的网络环境提出优化建议。请问有什么可以帮助您的？</p>
                            </div>
                        </div>
                    </div>
                    <div class="chat-input">
                        <form id="chat-form">
                            <div class="input-group">
                                <input type="text" class="form-control" id="chat-input" placeholder="输入您的问题..." autocomplete="off">
                                <button class="btn btn-primary" type="submit" id="chat-submit">
                                    <span class="spinner-border spinner-border-sm d-none" id="chat-spinner" role="status" aria-hidden="true"></span>
                                    发送
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">网络优化建议</h5>
            </div>
            <div class="card-body">
                <div class="accordion" id="optimization-accordion">
                    {% if optimizations %}
                        {% for optimization in optimizations %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="optimization-heading-{{ loop.index }}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#optimization-collapse-{{ loop.index }}" aria-expanded="false" aria-controls="optimization-collapse-{{ loop.index }}">
                                        {{ optimization.title }}
                                        {% if optimization.priority == 'high' %}
                                            <span class="badge bg-danger ms-2">高优先级</span>
                                        {% elif optimization.priority == 'medium' %}
                                            <span class="badge bg-warning ms-2">中优先级</span>
                                        {% else %}
                                            <span class="badge bg-info ms-2">低优先级</span>
                                        {% endif %}
                                    </button>
                                </h2>
                                <div id="optimization-collapse-{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="optimization-heading-{{ loop.index }}" data-bs-parent="#optimization-accordion">
                                    <div class="accordion-body">
                                        <p>{{ optimization.description }}</p>
                                        {% if optimization.steps %}
                                            <h6>建议步骤：</h6>
                                            <ol>
                                                {% for step in optimization.steps %}
                                                    <li>{{ step }}</li>
                                                {% endfor %}
                                            </ol>
                                        {% endif %}
                                        {% if optimization.benefits %}
                                            <h6>预期效益：</h6>
                                            <ul>
                                                {% for benefit in optimization.benefits %}
                                                    <li>{{ benefit }}</li>
                                                {% endfor %}
                                            </ul>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-info">
                            <h5>暂无优化建议</h5>
                            <p>AI助手尚未生成任何网络优化建议。随着更多设备数据的收集，系统将开始提供针对性的优化建议。</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const diagnosticForm = document.getElementById('diagnostic-form');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        
        // 诊断表单提交事件
        if (diagnosticForm) {
            diagnosticForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 显示加载动画
                document.getElementById('diagnostic-spinner').classList.remove('d-none');
                document.getElementById('diagnostic-submit').setAttribute('disabled', 'disabled');
                
                // 获取表单数据
                const deviceId = document.getElementById('device-select').value;
                const issueDescription = document.getElementById('issue-description').value;
                
                // 调用诊断API
                generateDiagnostic(deviceId, issueDescription)
                .then(result => {
                    // 隐藏加载动画
                    document.getElementById('diagnostic-spinner').classList.add('d-none');
                    document.getElementById('diagnostic-submit').removeAttribute('disabled');
                    
                    // 显示结果
                    document.getElementById('diagnostic-result').classList.remove('d-none');
                    document.getElementById('diagnostic-content').innerHTML = result;
                })
                .catch(error => {
                    console.error('Error:', error);
                    // 隐藏加载动画
                    document.getElementById('diagnostic-spinner').classList.add('d-none');
                    document.getElementById('diagnostic-submit').removeAttribute('disabled');
                    
                    // 显示错误消息
                    document.getElementById('diagnostic-result').classList.remove('d-none');
                    document.getElementById('diagnostic-content').innerHTML = `
                        <div class="alert alert-danger">
                            <p><strong>诊断请求失败：</strong> 无法连接诊断服务</p>
                            <p>请检查网络连接并稍后重试</p>
                        </div>
                    `;
                });
            });
        }
        
        // 对话表单提交事件
        if (chatForm) {
            chatForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const userMessage = chatInput.value.trim();
                if (!userMessage) return;
                
                // 添加用户消息到聊天窗口
                addMessage('user', userMessage);
                
                // 清空输入框
                chatInput.value = '';
                
                // 显示加载动画
                document.getElementById('chat-spinner').classList.remove('d-none');
                document.getElementById('chat-submit').setAttribute('disabled', 'disabled');
                
                // 调用AI接口
                fetch('/api/assistant', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: userMessage
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // 隐藏加载动画
                    document.getElementById('chat-spinner').classList.add('d-none');
                    document.getElementById('chat-submit').removeAttribute('disabled');
                    
                    // 添加AI回复
                    addMessage('assistant', data.response);
                    
                    // 滚动到底部
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                })
                .catch(error => {
                    console.error('Error:', error);
                    // 隐藏加载动画
                    document.getElementById('chat-spinner').classList.add('d-none');
                    document.getElementById('chat-submit').removeAttribute('disabled');
                    
                    // 显示错误消息
                    addMessage('assistant', '抱歉，我遇到了一些问题，无法回答您的问题。请稍后再试。');
                    
                    // 滚动到底部
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
            });
        }
    });
    
    // 添加消息到聊天窗口
    function addMessage(sender, content) {
        const chatMessages = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        
        const paragraph = document.createElement('p');
        paragraph.textContent = content;
        
        messageContent.appendChild(paragraph);
        messageDiv.appendChild(messageContent);
        chatMessages.appendChild(messageDiv);
    }
    
    // 生成诊断结果
    function generateDiagnostic(deviceId, issueDescription) {
        // 调用后端API进行网络诊断
        return fetch('/api/device/diagnose', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                device_id: deviceId,
                issue_description: issueDescription
            })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                return `
                    <div class="alert alert-danger">
                        <p><strong>诊断失败：</strong> ${data.message || '未知错误'}</p>
                    </div>
                `;
            }
            
            // 构建诊断结果HTML
            let recommendations = '';
            if (data.recommendations && data.recommendations.length > 0) {
                recommendations = '<ul>';
                data.recommendations.forEach(rec => {
                    recommendations += `<li>${rec}</li>`;
                });
                recommendations += '</ul>';
            }
            
            return `
                <div class="alert alert-info mb-3">
                    <p><strong>设备：</strong> ${data.device_name} (${data.device_type})</p>
                    <p><strong>状态：</strong> <span class="badge ${getBadgeClass(data.device_status)}">${getStatusText(data.device_status)}</span></p>
                </div>
                
                <p><strong>问题分析：</strong></p>
                <p>${data.diagnosis || '无法分析问题'}</p>
                
                <p><strong>建议解决方案：</strong></p>
                ${recommendations || '<p>无可用的解决方案建议</p>'}
            `;
        })
        .catch(error => {
            console.error('Error:', error);
            return `
                <div class="alert alert-danger">
                    <p><strong>诊断请求失败：</strong> 无法连接诊断服务</p>
                    <p>请检查网络连接并稍后重试</p>
                </div>
            `;
        });
    }
    
    // 获取设备状态对应的徽章样式
    function getBadgeClass(status) {
        switch(status) {
            case 'online': return 'bg-success';
            case 'offline': return 'bg-secondary';
            case 'warning': return 'bg-warning text-dark';
            case 'error': return 'bg-danger';
            default: return 'bg-info';
        }
    }
    
    // 获取状态文本
    function getStatusText(status) {
        switch(status) {
            case 'online': return '在线';
            case 'offline': return '离线';
            case 'warning': return '警告';
            case 'error': return '错误';
            default: return status;
        }
    }
</script>
<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: 400px;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
    }
    
    .chat-input {
        border-top: 1px solid #dee2e6;
        padding: 0.75rem;
    }
    
    .message {
        margin-bottom: 1rem;
        max-width: 80%;
    }
    
    .message.user {
        align-self: flex-end;
    }
    
    .message.assistant {
        align-self: flex-start;
    }
    
    .message-content {
        padding: 0.75rem;
        border-radius: 0.5rem;
    }
    
    .message.user .message-content {
        background-color: #007bff;
        color: #fff;
    }
    
    .message.assistant .message-content {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
    }
</style>
{% endblock %}
