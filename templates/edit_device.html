{% extends "base.html" %}

{% block title %}编辑设备 - 网络智能监控平台{% endblock %}

{% block header %}编辑设备{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header">
                设备信息
            </div>
            <div class="card-body">
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category if category != 'message' else 'info' }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
                {% endwith %}
                
                <form method="POST" action="{{ url_for('edit_device', device_id=device.id) }}">
                    <div class="mb-3">
                        <label for="name" class="form-label">设备名称</label>
                        <input type="text" class="form-control" id="name" name="name" 
                               value="{{ device.name }}" required>
                        <div class="form-text">为设备指定一个易于识别的名称</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="ip_address" class="form-label">IP地址</label>
                        <input type="text" class="form-control" id="ip_address" name="ip_address" 
                               pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$" 
                               value="{{ device.ip_address }}"
                               placeholder="例如：192.168.1.1" required>
                        <div class="form-text">设备的IP地址，格式为四段点分十进制</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="device_type" class="form-label">设备类型</label>
                        <select class="form-select" id="device_type" name="device_type" required>
                            <option value="">请选择...</option>
                            <option value="router" {% if device.device_type == 'router' %}selected{% endif %}>路由器</option>
                            <option value="switch" {% if device.device_type == 'switch' %}selected{% endif %}>交换机</option>
                            <option value="firewall" {% if device.device_type == 'firewall' %}selected{% endif %}>防火墙</option>
                            <option value="server" {% if device.device_type == 'server' %}selected{% endif %}>服务器</option>
                            <option value="workstation" {% if device.device_type == 'workstation' %}selected{% endif %}>工作站</option>
                            <option value="other" {% if device.device_type == 'other' %}selected{% endif %}>其他</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="snmp_community" class="form-label">SNMP社区字符串</label>
                        <input type="text" class="form-control" id="snmp_community" name="snmp_community" 
                               value="{{ device.snmp_community }}" 
                               placeholder="例如：public">
                        <div class="form-text">如果设备支持SNMP，请输入SNMP社区字符串（通常为"public"或"private"）</div>
                    </div>
                    
                    <hr class="my-4">
                    <h5>SSH登录信息</h5>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="ssh_enabled" name="ssh_enabled" value="1" 
                               {% if device.ssh_enabled %}checked{% endif %}>
                        <label class="form-check-label" for="ssh_enabled">启用SSH连接</label>
                    </div>
                    
                    <div id="ssh-credentials-section" style="display: {% if device.ssh_enabled %}block{% else %}none{% endif %};">
                        <div class="mb-3">
                            <label for="ssh_username" class="form-label">SSH用户名</label>
                            <input type="text" class="form-control" id="ssh_username" name="ssh_username" 
                                   value="{{ device.ssh_username }}" 
                                   placeholder="例如：admin">
                        </div>
                        
                        <div class="mb-3">
                            <label for="ssh_password" class="form-label">SSH密码</label>
                            <input type="password" class="form-control" id="ssh_password" name="ssh_password">
                            <div class="form-text">出于安全考虑，密码不会显示。如需更改，请输入新密码，否则将保留原密码。</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="ssh_port" class="form-label">SSH端口</label>
                            <input type="number" class="form-control" id="ssh_port" name="ssh_port" 
                                   value="{{ device.ssh_port }}" 
                                   min="1" max="65535">
                        </div>
                        
                        <div class="mb-3">
                            <label for="ssh_key_file" class="form-label">SSH密钥文件（可选）</label>
                            <input type="text" class="form-control" id="ssh_key_file" name="ssh_key_file" 
                                   value="{{ device.ssh_key_file }}" 
                                   placeholder="例如：/path/to/key.pem">
                            <div class="form-text">如果使用SSH密钥认证，请输入密钥文件的绝对路径</div>
                        </div>
                        
                        <div class="mb-3">
                            <button type="button" id="test_ssh_connection" class="btn btn-outline-primary">测试SSH连接</button>
                            <span id="ssh_test_result" class="ms-3"></span>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="mb-3">
                        <label for="location" class="form-label">位置</label>
                        <input type="text" class="form-control" id="location" name="location" 
                               value="{{ device.location }}" 
                               placeholder="例如：数据中心A区">
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">描述</label>
                        <textarea class="form-control" id="description" name="description" rows="3">{{ device.description }}</textarea>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('devices') }}" class="btn btn-secondary me-md-2">取消</a>
                        <button type="submit" class="btn btn-primary">保存更改</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 在页面加载完成后，添加IP地址验证
    document.addEventListener('DOMContentLoaded', function() {
        const ipAddressInput = document.getElementById('ip_address');
        
        ipAddressInput.addEventListener('input', function() {
            const ipPattern = /^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
            
            if (this.value && !ipPattern.test(this.value)) {
                this.setCustomValidity('请输入有效的IP地址，格式为四段点分十进制（例如：192.168.1.1）');
            } else {
                this.setCustomValidity('');
            }
        });
        
        // SSH启用/禁用逻辑
        const sshEnabledCheckbox = document.getElementById('ssh_enabled');
        const sshCredentialsSection = document.getElementById('ssh-credentials-section');
        
        sshEnabledCheckbox.addEventListener('change', function() {
            if (this.checked) {
                sshCredentialsSection.style.display = 'block';
            } else {
                sshCredentialsSection.style.display = 'none';
            }
        });
        
        // SSH连接测试
        const testSSHButton = document.getElementById('test_ssh_connection');
        const sshTestResult = document.getElementById('ssh_test_result');
        
        testSSHButton.addEventListener('click', function() {
            const ipAddress = document.getElementById('ip_address').value;
            const sshUsername = document.getElementById('ssh_username').value;
            const sshPassword = document.getElementById('ssh_password').value;
            const sshPort = document.getElementById('ssh_port').value || 22;
            const sshKeyFile = document.getElementById('ssh_key_file').value;
            
            if (!ipAddress || !sshUsername || (!sshPassword && !sshKeyFile)) {
                sshTestResult.innerHTML = '<span class="text-danger">请填写完整的SSH登录信息</span>';
                return;
            }
            
            // 禁用测试按钮，显示加载状态
            testSSHButton.disabled = true;
            sshTestResult.innerHTML = '<span class="text-info">正在测试连接...</span>';
            
            // 发送SSH测试请求
            fetch('/api/test_ssh_connection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    ip_address: ipAddress,
                    username: sshUsername,
                    password: sshPassword,
                    port: sshPort,
                    key_file: sshKeyFile
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    sshTestResult.innerHTML = '<span class="text-success">连接成功！</span>';
                } else {
                    sshTestResult.innerHTML = `<span class="text-danger">连接失败: ${data.error}</span>`;
                }
            })
            .catch(error => {
                sshTestResult.innerHTML = `<span class="text-danger">请求失败: ${error}</span>`;
            })
            .finally(() => {
                // 恢复测试按钮
                testSSHButton.disabled = false;
            });
        });
    });
</script>
{% endblock %}
